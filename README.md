# Elastic Job分布式定时任务管理系统框架


## 项目描述
Elastic Job是一个分布式定时任务调度框架，旨在解决传统任务管理系统资源分配不均，大规模分布式环境中定时任务调度困难的问题。
Elastic Job提供即时、定时和每日三种任务类型，允许用户自主定义任务的执行方式。它能够动态增加、减少节点，并根据节点的负载情况智能分配任务，从而均衡使用各节点的资源。此外，Elastic Job 可以跟踪任务的执行状态及结果，并对执行失败的任务自动进行重试，确保任务最终完成。
## 如何使用
用户使用前可以根据任务需求对slaveService中的runJob方法进行重写，然后需要配置好节点的信息，并对Redis集群进行初始化，设置以'cluster'为key值的分布式锁，再在MySQL数据库中初始化jobinfo和jobresult表即可运行启动，等待其他节点接入或是本节点接入主节点。接下来就可以启动客户端连接至服务端，对任务信息初始化后即可向服务器发送AddJob的请求，等待服务端调度执行。用户还可以通过客户端向服务端发送DeleteJob、GetAllJobs、GetAllResult、GetJobStatus等请求。
## 具体设计
项目分为客户端和服务端，客户端提供增删改查接口供用户调用。服务端由主节点和从节点集群组成，主从关系由主从选举的方式确定。主节点负责任务持久化和分发工作，内部维护三个队列，一个是watingJob，这个是优先队列存放新添加的任务或是从数据库中拉取出来未到执行时间的任务。主节点中有一个持续执行的线程changeJob会不断地比较当前时间和队头任务的执行时间，对到达执行时间的任务会移动到preparedJob队列中。preparedJob队列就是存放已经到运行时间的任务，这时主节点再收到子节点的getJob请求时，会根据任务参数和子节点资源进行任务分配。分配出去的任务就会被添加到runningJob的任务队列中，任务执行完毕后则会被剔除runningJob队列。子节点负责按用户定义的方式执行接收到的任务，执行结果会直接由子节点写入数据库而不用将结果发送给主节点存储。
### 1.主从选举
节点初次启动进行模式选择，检查自身是否获取到redis集群锁，若以获取到则以主节点模式启动，发布gRPC服务，并将ip和port存放到redis中，没有获取到则以从节点模式启动，读取redis中的信息后连接至主节点。
节点启动后会立刻开启一个线程，每隔一段时间拉取redis中的集群锁。每次获取到集群锁的节点都要比较redis中存放的ip和端口号是否与自身的相同，相同则代表主机点没有改变，继续当前服务。不同则要重新发布gRPC服务，并将redis中的ip和port更换为自身的。
### 2.节点间通信
主从节点间通信采用的是gRPC服务，考虑到gRPC优秀的性能而且可以使用Protobuf自动生成客户端和服务器端代码。
## 目录树
├─src                                                                                                                                                                                                                                            
│ └─main                                                                                                                                                                                                                                         
│    └──java                                                                                                                                                                                                                                     
│      ├─com   
│      │  └─choi                                                                                                                                                                                                                                
│      │      ├─config                                                                                                                                                                                                                           
│      │      ├─controller                                                                                                                                                                                                                      
│      │      ├─grpc gRPC服务                                                                                                                                                                                                                       
│      │      ├─mapper                                                                                                                                                                                                                              
│      │      ├─pojo                                                                                                                                                                                                                                
│      │      ├─service                                                                                                                                                                                                                             
│      │      │  ├─client 从节点业务                                               
│      │      │  └─server 主节点业务                                                    
│      │      └─utils                                                                               
│      └─proto                                                                             
└─ README.md                                                                                          